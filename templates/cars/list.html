{% extends 'base.html' %}
{% block title %}{% if my_list %}Мои объявления{% else %}Каталог{% endif %}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">{% if my_list %}Мои объявления{% else %}Каталог автомобилей{% endif %}</h3>
  {% if current_user.is_authenticated and (current_user.is_seller or current_user.is_admin) %}
    <div class="d-flex gap-2">
      <a href="{{ url_for('cars.create') }}" class="btn btn-primary">Добавить</a>
      {% if not my_list %}
        <a class="btn btn-outline-secondary" href="{{ url_for('cars.my') }}">Мои объявления</a>
      {% endif %}
    </div>
  {% endif %}
</div>

<form class="row g-2 mb-3">
  <div class="col-md-4">
    <input type="text" class="form-control" name="q" placeholder="Поиск (марка/модель/VIN)" value="{{ q }}">
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-secondary">Искать</button>
  </div>
</form>

<div class="table-responsive">
<table class="table align-middle">
  <thead>
    <tr>
      <th>Фото</th>
      <th>VIN</th>
      <th>Марка</th>
      <th>Модель</th>
      <th>Год</th>
      <th>Цена</th>
      <th>Статус</th>
      <th class="text-end"></th>
    </tr>
  </thead>
  <tbody>
    {% for c in cars %}
    <tr>
      <td style="width:120px">
        {% set img_src = None %}
        {% if c.image_path %}
          {% set img_src = url_for('static', filename='uploads/' ~ c.image_path) %}
        {% elif c.image_url %}
          {% set img_src = c.image_url %}
        {% endif %}
        {% if img_src %}
          <img src="{{ img_src }}" alt=""
               style="width:120px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #1f2937;">
        {% else %}
          <span class="text-muted">—</span>
        {% endif %}
      </td>
      <td>{{ c.vin }}</td>
      <td>{{ c.brand }}</td>
      <td>{{ c.model }}</td>
      <td>{{ c.year }}</td>
      <td>{{ c.price | money(c.currency) }}</td>
      <td>
        {% if c.status=='sold' %}
          <span class="badge bg-secondary">Продано</span>
        {% elif c.status=='reserved' %}
          <span class="badge bg-warning text-dark">Резерв</span>
        {% else %}
          <span class="badge bg-success">В наличии</span>
        {% endif %}
      </td>
      <td class="text-end">
        {% if current_user.is_authenticated and current_user.is_buyer %}
          <a href="{{ url_for('cars.detail', car_id=c.id) }}" class="btn btn-sm btn-outline-secondary">Подробнее</a>
          {% if c.status != 'sold' %}
            <a href="{{ url_for('inq.new', car_id=c.id) }}" class="btn btn-sm btn-primary">Связаться</a>
          {% endif %}
        {% elif current_user.is_authenticated and (current_user.is_admin or (current_user.is_seller and c.seller_id==current_user.id)) %}
          <a href="{{ url_for('cars.edit', car_id=c.id) }}" class="btn btn-sm btn-outline-primary">Изм.</a>
          <form action="{{ url_for('cars.delete', car_id=c.id) }}" method="post" class="d-inline"
                onsubmit="return confirm('Удалить объявление?')">
            <button class="btn btn-sm btn-outline-danger">Удалить</button>
          </form>
        {% else %}
          <a href="{{ url_for('cars.detail', car_id=c.id) }}" class="btn btn-sm btn-outline-secondary">Подробнее</a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endblock %}
